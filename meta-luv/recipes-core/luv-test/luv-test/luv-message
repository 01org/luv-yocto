#!/bin/bash
#
# Copyright 2018 Intel Corporation; author Megha Dey
#
LUVDEBUG_LOG=/tmp/luv-debug.log

setup_debug_log()
{
    debug=`grep -o "luv.debug=[1-3]" /proc/cmdline`
    if [ ! -z $debug ]; then
        dbg_lvl=`echo $debug | cut -d'=' -f 2`
        luv_msg_write "Enable LUV debug level $dbg_lvl..."
        LUVDEBUG="$dbg_lvl"
        [ $dbg_lvl -ge 2 ] && set -v
        [ $dbg_lvl -eq 3 ] && set -x
    fi
}

setup_output()
{
    thistty=$(tty)

    if [ ! -z ${LUVDEBUG} ]; then
        logfiles="${thistty} ${LUVDEBUG_LOG}"
    else
        logfiles="${thistty}"
    fi

    exec &> >(tee -a ${logfiles})
}

print_line()
{
    while read line ; do
    case $line in
        *+* )
        echo "[    `cut -d " " -f 1 /proc/uptime`0000]  $line"
        ;;
        * )
        echo "[    `cut -d " " -f 1 /proc/uptime`0000] $line"
        ;;
    esac
    done
}

luv_msg_write() {
    /bin/plymouth display-message --text="$1"

    if [ $# == 2 ]; then
         sleep $2
         luv_msg_hide $1
    fi

    echo "$1" | print_line
}

luv_msg_hide() {
    /bin/plymouth hide-message --text="$1"
}

setup_debug_log
setup_output
